{% extends 'base.html' %}
{% load static %}

{% block title %}Yeni Iris Ekle - Iris Sınıflandırma Sistemi{% endblock %}

{% block content %}
<div class="forms-container">
    <h2>Yeni Iris Örneği Ekle</h2>
    
    <div class="info-box">
        <p>Aşağıdaki formu doldurarak yeni bir Iris örneği ekleyebilirsiniz. Tüm ölçümleri santimetre (cm) cinsinden giriniz.</p>
    </div>
    
    <form method="post" action="{% url 'iris_ekle' %}">
        {% csrf_token %}
        <div class="form-group">
            <label for="sepal_length">Çanak Yaprağı Uzunluğu (cm):</label>
            <input type="number" id="sepal_length" name="sepal_length" step="0.1" min="0" 
                   placeholder="Örn: 5.1" required value="{{ form.sepal_length.value|default:'' }}">
        </div>
        
        <div class="form-group">
            <label for="sepal_width">Çanak Yaprağı Genişliği (cm):</label>
            <input type="number" id="sepal_width" name="sepal_width" step="0.1" min="0" 
                   placeholder="Örn: 3.5" required value="{{ form.sepal_width.value|default:'' }}">
        </div>
        
        <div class="form-group">
            <label for="petal_length">Taç Yaprağı Uzunluğu (cm):</label>
            <input type="number" id="petal_length" name="petal_length" step="0.1" min="0" 
                   placeholder="Örn: 1.4" required value="{{ form.petal_length.value|default:'' }}">
        </div>
        
        <div class="form-group">
            <label for="petal_width">Taç Yaprağı Genişliği (cm):</label>
            <input type="number" id="petal_width" name="petal_width" step="0.1" min="0" 
                   placeholder="Örn: 0.2" required value="{{ form.petal_width.value|default:'' }}">
        </div>
        
        <div class="form-group">
            <label for="ml_model">ML Model Seçin:</label>
            <select id="ml_model" name="ml_model" style="margin-bottom: 10px;">
                <option value="knn">K-En Yakın Komşu (KNN)</option>
                <option value="svm">Destek Vektör Makinesi (SVM)</option>
                <option value="decision_tree">Karar Ağacı Sınıflandırıcı</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="species">Tür:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="species" name="species" required style="flex: 1;">
                    <option value="">Tür Seçiniz</option>
                    <option value="Iris-setosa" {% if form.species.value == 'Iris-setosa' %}selected{% endif %}>Iris Setosa</option>
                    <option value="Iris-versicolor" {% if form.species.value == 'Iris-versicolor' %}selected{% endif %}>Iris Versicolor</option>
                    <option value="Iris-virginica" {% if form.species.value == 'Iris-virginica' %}selected{% endif %}>Iris Virginica</option>
                </select>
                <button type="button" id="tahmin-btn" class="btn btn-predict">Tahmin Et</button>
            </div>
            <div id="tahmin-sonuc" style="margin-top: 10px;"></div>
        </div>
        
        <div class="form-group">
            <label for="location">Lokasyon:</label>
            <select id="location" name="location" required>
                <option value="">Lokasyon Seçiniz...</option>
                {% for location in locations %}
                <option value="{{ location.id }}" {% if form.location.value == location.id %}selected{% endif %}>
                    {{ location.name }} - {{ location.city }}, {{ location.country }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        {% if error %}
        <div class="message error">{{ error }}</div>
        {% endif %}
        
        {% if success %}
        <div class="message success">{{ success }}</div>
        {% endif %}
        
        <input type="submit" value="Iris Örneği Ekle">
        <input type="button" value="Formu Temizle" onclick="this.form.reset()">
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('tahmin-btn').addEventListener('click', function() {
    const sepal_length = document.getElementById('sepal_length').value;
    const sepal_width = document.getElementById('sepal_width').value;
    const petal_length = document.getElementById('petal_length').value;
    const petal_width = document.getElementById('petal_width').value;
    const ml_model = document.getElementById('ml_model').value;
    const sonucDiv = document.getElementById('tahmin-sonuc');
    
    // Validasyon
    if (!sepal_length || !sepal_width || !petal_length || !petal_width) {
        sonucDiv.innerHTML = '<span class="message error">Lütfen tüm ölçüm alanlarını doldurun!</span>';
        return;
    }
    
    // Loading göster
    sonucDiv.innerHTML = '<span style="color: #4a9eff;">Tahmin yapılıyor...</span>';
    this.disabled = true;
    
    fetch('{% url "ajax_tahmin" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            sepal_length: parseFloat(sepal_length),
            sepal_width: parseFloat(sepal_width),
            petal_length: parseFloat(petal_length),
            petal_width: parseFloat(petal_width),
            ml_model: ml_model
        })
    })
    .then(response => response.json())
    .then(data => {
        this.disabled = false;
        if (data.success) {
            // Dropdown'dan türü seç
            const speciesSelect = document.getElementById('species');
            speciesSelect.value = data.prediction;
            sonucDiv.innerHTML = '<span class="message success">✓ Tahmin: ' + data.prediction + '</span>';
        } else {
            sonucDiv.innerHTML = '<span class="message error">Hata: ' + data.error + '</span>';
        }
    })
    .catch(error => {
        this.disabled = false;
        sonucDiv.innerHTML = '<span class="message error">Bağlantı hatası!</span>';
        console.error('Error:', error);
    });
});
</script>
{% endblock %}
